<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Dashboard - AIESEC TM</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header class="dashboard-header">
            <h1>Welcome, <span id="memberName"></span></h1>
            <div class="header-actions">
                <nav class="dashboard-nav" id="dashboardNav"></nav>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- Stats Cards -->
            <div class="stat-card">
                <h3>Attendance</h3>
                <div class="stat-value" id="attendancePercent">0%</div>
                <div class="stat-label">Overall Attendance</div>
            </div>

            <div class="stat-card">
                <h3>Pulse Score</h3>
                <div class="stat-value" id="pulseScore">0</div>
                <div class="stat-label">Last 4 Weeks Average</div>
            </div>

            <div class="stat-card">
                <h3>Task Score</h3>
                <div class="stat-value" id="taskScore">0</div>
                <div class="stat-label">Performance Score</div>
            </div>

            <div class="stat-card">
                <h3>Status</h3>
                <div class="stat-value status-badge" id="engagementStatus">-</div>
                <div class="stat-label">Engagement</div>
            </div>
        </div>

        <!-- Member Info -->
        <div class="info-section">
            <h2>Your Information</h2>
            <div class="info-grid">
                <div class="info-item">
                    <strong>Function:</strong> <span id="memberFunction"></span>
                </div>
                <div class="info-item">
                    <strong>Team Leader:</strong> <span id="teamLeader"></span>
                </div>
                <div class="info-item">
                    <strong>Member ID:</strong> <span id="memberIdDisplay"></span>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="actions-section">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAttendanceForm()">Check In (QR)</button>
                <button class="btn btn-primary" onclick="openPulseForm()">Weekly Pulse</button>
            </div>
        </div>

        <!-- Tasks Section -->
        <div class="tasks-section">
            <h2>Your Tasks</h2>
            <div id="tasksList" class="tasks-list">
                <p>Loading tasks...</p>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="app.js"></script>
    <script>
        const APPS_SCRIPT_URL = window.APPS_SCRIPT_URL || 'https://script.google.com/macros/s/AKfycbyltRZHQhz4XV1Q010ZtZau3AB5H5jalNqFc3KFr90nnMNCOG_2K3YfbYrIMYgbdzLi/exec';
        const memberId = sessionStorage.getItem('memberId');
        const hasFullAccess = sessionStorage.getItem('hasFullAccess') === 'true';
        const roleType = sessionStorage.getItem('roleType');
        const memberFunction = sessionStorage.getItem('memberFunction');
        
        // Allow access for all members, VP TM, and TM Team Leaders
        const isVPTM = sessionStorage.getItem('isVPTM') === 'true';
        const canAccess = memberId || hasFullAccess || isVPTM || 
                         (roleType === 'Team Leader' && memberFunction === 'TM');
        
        if (!canAccess) {
            window.location.href = 'index.html';
        }

        // Show navigation for users with full access (VP TM or TM Team Leader)
        if (hasFullAccess || roleType === 'VP TM' || (roleType === 'Team Leader' && memberFunction === 'TM')) {
            showDashboardNavigation();
        }

        // Load member data
        loadMemberData();

        async function loadMemberData() {
            try {
                const response = await fetch(APPS_SCRIPT_URL + '?action=getMember&memberId=' + memberId);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    document.getElementById('memberName').textContent = data.name;
                    document.getElementById('memberIdDisplay').textContent = data.memberId;
                    document.getElementById('memberFunction').textContent = data.function;
                    document.getElementById('teamLeader').textContent = data.teamLeader;
                    document.getElementById('attendancePercent').textContent = data.attendancePercent.toFixed(1) + '%';
                    document.getElementById('pulseScore').textContent = data.pulseScore.toFixed(1);
                    document.getElementById('taskScore').textContent = data.taskScore.toFixed(1);
                    
                    const statusEl = document.getElementById('engagementStatus');
                    statusEl.textContent = data.engagementStatus;
                    statusEl.className = 'stat-value status-badge status-' + data.engagementStatus.toLowerCase();
                } else {
                    alert('Error loading data: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading member data');
            }
        }

        function openAttendanceForm() {
            // Open the standalone attendance form page
            window.open('attendance-form.html?memberId=' + memberId, '_blank', 'width=600,height=700');
        }

        function openPulseForm() {
            // Open the standalone pulse form page
            window.open('pulse-form.html?id=' + memberId, '_blank', 'width=700,height=900');
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>

