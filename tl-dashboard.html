<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Leader Dashboard - AIESEC TM</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header class="dashboard-header">
            <h1>Team Leader Dashboard</h1>
            <div class="header-actions">
                <nav class="dashboard-nav" id="dashboardNav"></nav>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="dashboard-grid">
            <div class="stat-card">
                <h3>Team Members</h3>
                <div class="stat-value" id="teamSize">0</div>
            </div>
            <div class="stat-card">
                <h3>Avg Attendance</h3>
                <div class="stat-value" id="avgAttendance">0%</div>
            </div>
            <div class="stat-card">
                <h3>Avg Pulse</h3>
                <div class="stat-value" id="avgPulse">0</div>
            </div>
            <div class="stat-card">
                <h3>At-Risk Members</h3>
                <div class="stat-value" id="atRiskCount">0</div>
            </div>
        </div>

        <!-- Team Members Table -->
        <div class="table-section">
            <h2>Team Members</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Attendance %</th>
                        <th>Pulse Score</th>
                        <th>Task Score</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="teamMembersTable">
                    <tr><td colspan="6">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- At-Risk Members -->
        <div class="at-risk-section">
            <h2>At-Risk Members</h2>
            <div id="atRiskList" class="at-risk-list">
                <p>No at-risk members</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions-section">
            <h2>Team Management</h2>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openCreateMeeting()">Create Meeting</button>
                <button class="btn btn-primary" onclick="openAssignTask()">Assign Task</button>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-section">
            <div class="chart-container">
                <h3>Attendance Trend</h3>
                <canvas id="attendanceChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Pulse Trend</h3>
                <canvas id="pulseChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="meetingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('meetingModal')">&times;</span>
            <h2>Create Meeting</h2>
            <form id="meetingForm">
                <div class="form-group">
                    <label>Meeting Name</label>
                    <input type="text" id="meetingName" required>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="meetingDate" required>
                </div>
                <div class="form-group">
                    <label>Time</label>
                    <input type="time" id="meetingTime" required>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="meetingLocation" required>
                </div>
                <button type="submit" class="btn btn-primary">Create Meeting</button>
            </form>
        </div>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('taskModal')">&times;</span>
            <h2>Assign Task</h2>
            <form id="taskForm">
                <div class="form-group">
                    <label>Assign To</label>
                    <select id="taskAssignTo" required></select>
                </div>
                <div class="form-group">
                    <label>Task Name</label>
                    <input type="text" id="taskName" required>
                </div>
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="date" id="taskDueDate" required>
                </div>
                <button type="submit" class="btn btn-primary">Assign Task</button>
            </form>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="app.js"></script>
    <script>
        // APPS_SCRIPT_URL is already declared in app.js, just use it
        const teamLeaderName = sessionStorage.getItem('teamLeaderName');
        const hasFullAccess = sessionStorage.getItem('hasFullAccess') === 'true';
        const roleType = sessionStorage.getItem('roleType');
        const memberFunction = sessionStorage.getItem('memberFunction');
        
        // Allow access if: is Team Leader OR VP TM OR TM Team Leader
        const isVPTM = sessionStorage.getItem('isVPTM') === 'true';
        const canAccess = teamLeaderName || hasFullAccess || isVPTM || 
                         (roleType === 'Team Leader' && memberFunction === 'TM');
        
        if (!canAccess) {
            window.location.href = 'index.html';
        }

        // Show navigation for users with full access (VP TM or TM Team Leader)
        if (hasFullAccess || isVPTM || (roleType === 'Team Leader' && memberFunction === 'TM')) {
            showDashboardNavigation();
        }

        // For VP TM or TM Team Leader, they can view any team
        // For regular TL, use their team leader name
        const effectiveTeamLeader = (isVPTM || hasFullAccess || (roleType === 'Team Leader' && memberFunction === 'TM')) 
            ? null // Will show all teams or allow selection
            : teamLeaderName;

        loadTeamData(effectiveTeamLeader);

        async function loadTeamData(teamLeader = null) {
            try {
                // If no team leader specified (VP TM or TM TL), use the stored team leader name or show all
                const tlToUse = teamLeader || teamLeaderName || sessionStorage.getItem('teamLeaderName');
                
                // For VP TM or TM TL, we could show all teams, but for now use their own team if they have one
                if (!tlToUse && (isVPTM || hasFullAccess || (roleType === 'Team Leader' && memberFunction === 'TM'))) {
                    // VP TM or TM TL viewing - could show all teams or their own team
                    // For now, if they have a team leader name, use it; otherwise show message
                    document.getElementById('teamMembersTable').innerHTML = 
                        '<tr><td colspan="6">Select a team to view, or use VP TM dashboard for LC-wide view</td></tr>';
                    return;
                }
                
                const response = await fetch(APPS_SCRIPT_URL + '?action=getTeam&teamLeader=' + encodeURIComponent(tlToUse));
                const result = await response.json();
                
                if (result.success) {
                    const teamData = result.data;
                    document.getElementById('teamSize').textContent = teamData.length;
                    
                    const avgAttendance = teamData.reduce((sum, m) => sum + m.attendancePercent, 0) / teamData.length;
                    const avgPulse = teamData.reduce((sum, m) => sum + m.pulseScore, 0) / teamData.length;
                    const atRiskCount = teamData.filter(m => m.engagementStatus === 'RED').length;
                    
                    document.getElementById('avgAttendance').textContent = avgAttendance.toFixed(1) + '%';
                    document.getElementById('avgPulse').textContent = avgPulse.toFixed(1);
                    document.getElementById('atRiskCount').textContent = atRiskCount;
                    
                    // Populate table
                    const tableBody = document.getElementById('teamMembersTable');
                    tableBody.innerHTML = teamData.map(member => `
                        <tr>
                            <td>${member.name}</td>
                            <td>${member.attendancePercent.toFixed(1)}%</td>
                            <td>${member.pulseScore.toFixed(1)}</td>
                            <td>${member.taskScore.toFixed(1)}</td>
                            <td><span class="status-badge status-${member.engagementStatus.toLowerCase()}">${member.engagementStatus}</span></td>
                            <td><button class="btn btn-small" onclick="viewMember('${member.memberId}')">View</button></td>
                        </tr>
                    `).join('');
                    
                    // Populate at-risk list
                    const atRiskList = document.getElementById('atRiskList');
                    const atRiskMembers = teamData.filter(m => m.engagementStatus === 'RED');
                    if (atRiskMembers.length > 0) {
                        atRiskList.innerHTML = atRiskMembers.map(m => `
                            <div class="at-risk-item">
                                <strong>${m.name}</strong> - Attendance: ${m.attendancePercent.toFixed(1)}%, Pulse: ${m.pulseScore.toFixed(1)}
                            </div>
                        `).join('');
                    } else {
                        atRiskList.innerHTML = '<p>No at-risk members</p>';
                    }
                    
                    // Populate task assign dropdown
                    const taskAssignTo = document.getElementById('taskAssignTo');
                    taskAssignTo.innerHTML = teamData.map(m => 
                        `<option value="${m.memberId}">${m.name}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading team data');
            }
        }

        function openCreateMeeting() {
            document.getElementById('meetingModal').style.display = 'block';
        }

        function openAssignTask() {
            document.getElementById('taskModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        document.getElementById('meetingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Implement meeting creation
            alert('Meeting creation - implement API call');
            closeModal('meetingModal');
        });

        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Implement task assignment
            alert('Task assignment - implement API call');
            closeModal('taskModal');
        });

        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>

